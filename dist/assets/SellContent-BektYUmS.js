import{A as K,a as X,r as n,R as U,j as e}from"./index-B99SmHNo.js";import{e as Q}from"./productServices-DgsMtQJT.js";import{u as ee}from"./useDebounce-Cuz9Wy3C.js";import{u as te}from"./useInfiniteScroll-BaLH5auh.js";import{f as S}from"./formatPeso-BGd6Nsev.js";import{M as se}from"./MessageToast-CfSi4MnN.js";async function ae(t){try{const s=new Date,l=Intl.DateTimeFormat().resolvedOptions().timeZone,r={...t,device_datetime:s.toISOString(),device_timezone:l};return(await K.post("/sales/store",r)).data}catch(s){throw console.error("Transaction failed:",s),console.error("Response:",s.response?.data),s}}function ne(){const t=X(),[s,l]=n.useState([]),[r,x]=n.useState([]),[m,f]=n.useState("All"),[h,q]=n.useState(""),[C,p]=n.useState(1),[v,b]=n.useState(!0),[N,w]=n.useState(!1),[_,g]=n.useState(null),[y,j]=n.useState(!1),[k,E]=n.useState(!1),[I,A]=n.useState(!1),[M,z]=n.useState(!1),[L,$]=n.useState(null),P=n.useRef(),c=ee(h,400),D=n.useCallback(async(a=1)=>{w(!0);try{const i=await Q(a,10,c,m),{data:u,hasMore:o}=i;l(d=>a===1?u:[...d,...u]),b(o)}catch{g({type:"error",text:"Failed to load products"})}finally{w(!1)}},[c,m]);n.useEffect(()=>{D(C)},[C,D]),n.useEffect(()=>{l([]),p(1),b(!0)},[c,m]);const B=n.useMemo(()=>{const a=new Set;s.forEach(u=>{Array.isArray(u.categories)&&u.categories.length>0?u.categories.forEach(o=>{o?.name&&a.add(o.name)}):a.add("Uncategorized")});const i=Array.from(a).map((u,o)=>({id:o+1,category_name:u}));return[{id:0,category_name:"All"},...i]},[s]);te(P,()=>{v&&!N&&p(a=>a+1)},v,N);const F=n.useMemo(()=>{const a=new Map;return s.forEach(i=>a.set(i.id,i.stock_quantity??0)),a},[s]),T=n.useCallback(a=>F.get(a)??0,[F]),O=n.useCallback(a=>{x(i=>{const u=i.find(d=>d.id===a.id),o=T(a.id);return u?u.quantity+1>o?(g({type:"info",text:"Stock limit reached"}),i):i.map(d=>d.id===a.id?{...d,quantity:d.quantity+1}:d):o===0?(g({type:"info",text:"Item out of stock"}),i):[...i,{id:a.id,quantity:1,product:a}]})},[T]),V=n.useCallback((a,i)=>{const u=T(a);i>u&&(i=u,g({type:"info",text:"Stock limit reached"})),x(o=>i<=0?o.filter(d=>d.id!==a):o.map(d=>d.id===a?{...d,quantity:i}:d))},[T]),W=n.useMemo(()=>r.reduce((a,i)=>a+Number(i.product?.price??0)*i.quantity,0),[r]),Z=n.useCallback(()=>{if(!r.length)return g({type:"info",text:"Cart is empty"});j(!0)},[r]),G=n.useCallback(async()=>{const a=[...r];if(!a.length){g({type:"info",text:"Cart is empty"}),j(!1);return}j(!1),E(!0);const i=a.reduce((o,d)=>o+Number(d.product.price??0)*d.quantity,0),u={items:a.map(o=>({product_id:o.id,quantity:o.quantity,snapshot_name:o.product.name,snapshot_price:o.product.price})),total_amount:i};try{const o=await ae(u);o?.sale_id||o?.sale?(l(d=>d.map(R=>{const H=a.find(J=>J.id===R.id);return H?{...R,stock_quantity:Math.max((R.stock_quantity??0)-H.quantity,0)}:R})),x([]),g({type:"success",text:o?.message||"Transaction successful!"}),p(1),b(!0)):g({type:"error",text:o?.message||"Transaction failed"})}catch(o){const d=o.response?.data?.message||o.message||"Transaction failed. Try again.";g({type:"error",text:d})}finally{E(!1)}},[r]);return n.useEffect(()=>{const a=i=>{r.length>0&&(i.preventDefault(),i.returnValue="")};return window.addEventListener("beforeunload",a),()=>window.removeEventListener("beforeunload",a)},[r]),{products:s,cartItems:r,categories:B,selectedCategory:m,searchInput:h,loaderRef:P,message:_,showConfirm:y,showClearCartConfirm:I,showLeaveCartDialog:M,isProcessing:k,total:W,isLoading:N,setSearchInput:q,setSelectedCategory:f,handleAddToCart:O,updateCartItem:V,handleCompletePurchase:Z,confirmTransaction:G,setCartItems:x,setShowConfirm:j,setShowClearCartConfirm:A,setShowLeaveCartDialog:z,setMessage:g,navigate:t,pendingNavigation:L,setPendingNavigation:$,getStockFor:T}}function Y(t){return!t.categories||!t.categories.length?"No Category":t.categories.map(s=>s.name).join(", ")}const re=({product:t,onAdd:s,style:l})=>{const r=t?.stock_quantity??t?.stock??0,x=t?.low_stock_threshold??5,m=()=>{r>0&&s(t)},f=t?.images_path?.length>0?t.images_path.find(h=>h.is_primary)?.image_path||t.images_path[0].image_path:t?.image||null;return e.jsxs("div",{style:l,onClick:m,className:`relative flex items-start justify-between p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out ${r<=0?"opacity-50 pointer-events-none":""}`,children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"shrink-0 w-34 h-34 rounded border border-gray-200 flex items-center justify-center bg-gray-100 overflow-hidden",children:f?e.jsx("img",{src:f,alt:t.name||"Product",className:"w-full h-full object-cover",onError:h=>h.target.style.display="none"}):e.jsx("span",{className:"text-gray-400 text-sm",children:"No Image"})}),e.jsxs("div",{className:"flex flex-col justify-between h-34 py-1",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-800 leading-tight",children:t.name||"Unnamed Product"}),e.jsx("p",{className:"text-base text-gray-500",children:Y(t)||"No Category"})]}),e.jsxs("p",{className:`text-base ${r<=x?"text-red-500":"text-gray-500"}`,children:["Stocks : ",r]})]})]}),e.jsxs("div",{className:"absolute top-4 right-5 text-base font-semibold text-gray-800 whitespace-nowrap",children:["Unit price : ",S(t.price)]})]})},oe=U.memo(re);function ie({item:t,product:s,stock:l,onUpdateQuantity:r,onLimit:x}){const m=s?.name??"Unavailable",f=Number(s?.price??0),h=f*t.quantity,q="/fallback.png",C=`https://via.placeholder.com/64x64.png?text=${encodeURIComponent(m.charAt(0)||"P")}`,p=s?.image||C,[v,b]=n.useState(t.quantity);n.useEffect(()=>{b(t.quantity)},[t.quantity]);const N=n.useCallback(y=>{const j=y.target.value.replace(/\D/g,""),k=j===""?"":Math.min(Number(j),l);b(k)},[l]),w=n.useCallback(()=>{const y=Number(v||0);r(t.id,y)},[v,t.id,r]),_=n.useCallback(()=>{t.quantity<l?r(t.id,t.quantity+1):x()},[t.id,t.quantity,l,r,x]),g=n.useCallback(()=>{r(t.id,Math.max(t.quantity-1,0))},[t.id,t.quantity,r]);return e.jsxs("div",{className:"border border-gray-300 rounded-lg p-3 bg-white",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-16 h-16 border border-gray-200 rounded flex items-center justify-center bg-gray-50 overflow-hidden",children:e.jsx("img",{src:p,alt:m,className:"object-cover w-full h-full rounded",onError:y=>{y.onerror=null,y.target.src=q}})}),e.jsxs("div",{className:"flex flex-col flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:m}),e.jsx("div",{className:"text-xs text-gray-500",children:Y(s)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Stocks: ",l]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["Unit Price: ",S(f)]}),e.jsxs("div",{className:"text-xs text-gray-600 font-medium",children:["Subtotal: ",S(h)]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Quantity:"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:g,type:"button",className:"w-6 h-6 border border-gray-300 rounded text-sm flex items-center justify-center hover:bg-gray-100 transition",children:"âˆ’"}),e.jsx("input",{type:"text",value:v,onChange:N,onBlur:w,className:"w-8 text-center border border-gray-300 rounded text-xs py-0.5"}),e.jsx("button",{onClick:_,type:"button",className:`w-6 h-6 border border-gray-300 rounded text-sm flex items-center justify-center transition ${t.quantity>=l?"opacity-50 cursor-not-allowed":"hover:bg-gray-100"}`,children:"+"})]})]})]})}const le=U.memo(ie,(t,s)=>t.item.quantity===s.item.quantity&&t.stock===s.stock&&t.product===s.product),ce=({cartItems:t=[],onConfirm:s,onClose:l,title:r="Confirm Purchase"})=>{console.log("Rendering ConfirmModal with cartItems:",t);const x=n.useMemo(()=>t.reduce((m,f)=>m+(f.product?.price??0)*f.quantity,0),[t]);return t.length===0?(console.log("ConfirmModal: cartItems empty!"),null):e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-50 px-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col  border-2 border-pink-400",style:{maxHeight:"90vh"},children:[e.jsx("div",{className:"px-6 py-5 border-b border-gray-200",children:e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:r})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:t.map(m=>e.jsxs("div",{className:"flex justify-between items-center py-3 text-base text-gray-700",children:[e.jsxs("span",{className:"font-normal",children:[m.product?.name??"Unavailable"," ",e.jsx("span",{className:"mx-2",children:"x"})," ",m.quantity]}),e.jsx("span",{className:"font-medium",children:S((m.product?.price??0)*m.quantity)})]},m.id))}),e.jsxs("div",{className:"px-6 py-5 border-t border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:"Total:"}),e.jsx("span",{className:"text-lg font-bold text-gray-900",children:S(x)})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:l,className:"px-6 py-2.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-medium",children:"Cancel"}),e.jsx("button",{onClick:s,className:"px-6 py-2.5 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition font-medium",children:"Confirm"})]})]})]})})},de=({onConfirm:t,onCancel:s,message:l,subMessage:r})=>e.jsxs("div",{className:"fixed inset-0 z-1000 flex items-center justify-center px-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black/50",onClick:s}),e.jsxs("div",{className:"relative z-10 bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 border-2 border-pink-500",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 leading-tight",children:l||"Are you sure you want to remove all items from your cart?"}),e.jsx("p",{className:"text-gray-400 text-lg",children:r||"This action cannot be undone."})]}),e.jsxs("div",{className:"mt-8 flex gap-4",children:[e.jsx("button",{onClick:s,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-gray-400 bg-gray-200 hover:bg-gray-300 focus:outline-none transition duration-150 ease-in-out",children:"Cancel"}),e.jsx("button",{onClick:t,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-white bg-pink-500 hover:bg-pink-600 focus:outline-none transition duration-150 ease-in-out",children:"Yes"})]})]})]}),me=({onConfirm:t,onCancel:s,message:l,subMessage:r})=>e.jsxs("div",{className:"fixed inset-0 z-1000 flex items-center justify-center px-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black/50",onClick:s}),e.jsxs("div",{className:"relative z-10 bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 border-2 border-pink-500",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 leading-tight",children:l}),e.jsx("p",{className:"text-gray-400 text-lg",children:r})]}),e.jsxs("div",{className:"mt-8 flex gap-4",children:[e.jsx("button",{onClick:s,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-gray-400 bg-gray-200 hover:bg-gray-300 focus:outline-none transition duration-150 ease-in-out",children:"Cancel"}),e.jsx("button",{onClick:t,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-white bg-pink-500 hover:bg-pink-600 focus:outline-none transition duration-150 ease-in-out",children:"Yes"})]})]})]});function pe(){const{products:t,cartItems:s,categories:l,selectedCategory:r,searchInput:x,loaderRef:m,message:f,showConfirm:h,showClearCartConfirm:q,showLeaveCartDialog:C,isProcessing:p,total:v,isLoading:b,setSearchInput:N,setSelectedCategory:w,handleAddToCart:_,updateCartItem:g,handleCompletePurchase:y,confirmTransaction:j,setCartItems:k,setShowConfirm:E,setShowClearCartConfirm:I,setShowLeaveCartDialog:A,setMessage:M,navigate:z,pendingNavigation:L,setPendingNavigation:$,getStockFor:P}=ne();return e.jsxs("div",{className:"flex flex-col md:flex-row h-[91vh]",children:[e.jsxs("div",{className:"flex-1 bg-white border border-gray-200 rounded-xl flex flex-col overflow-hidden mt-4 mx-4",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex gap-3",children:[e.jsx("input",{type:"text",placeholder:"Search items",value:x,onChange:c=>N(c.target.value),className:"flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500"}),e.jsx("select",{value:r,onChange:c=>w(c.target.value),className:"w-40 border border-gray-300 rounded-md px-3 py-2 text-sm focus:border-pink-500 focus:ring-1 focus:ring-pink-500 focus:outline-none transition-colors duration-200",children:l.map(c=>e.jsx("option",{value:c.category_name,children:c.category_name},c.id))})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-2",children:[t.length===0&&!b?e.jsx("div",{className:"text-center text-gray-500 text-sm py-8",children:"No products found"}):e.jsx("div",{className:"space-y-3",children:t.slice().sort((c,D)=>D.stock_quantity-c.stock_quantity).map(c=>e.jsx(oe,{product:c,onAdd:_,disabled:P(c.id)===0},c.id))}),b&&e.jsx("div",{className:"text-center text-gray-400 py-3",children:"Loading more..."}),e.jsx("div",{ref:m,className:"h-20"})]})]}),e.jsxs("div",{className:"w-full md:w-1/3 bg-white border border-gray-200 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"Transaction summary"}),s.length>0&&e.jsx("button",{onClick:()=>I(!0),className:"text-xs font-medium hover:text-gray-700 transition border-2 border-gray-200 p-1 px-2 rounded-md bg-gray-100",children:"Clear all"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:s.length===0?e.jsx("div",{className:"text-center text-sm text-gray-500 py-8",children:"No items selected"}):e.jsx("div",{className:"space-y-4",children:s.map(c=>e.jsx(le,{item:c,product:c.product,stock:P(c.id),onUpdateQuantity:g,onLimit:()=>M({type:"info",text:"Stock limit reached"})},c.id))})}),e.jsxs("div",{className:"border-t border-gray-200 p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("span",{className:"text-sm font-medium",children:"Total"}),e.jsx("span",{className:"text-sm font-semibold",children:S(v)})]}),e.jsx("button",{onClick:y,disabled:s.length===0||p,className:`w-full py-2 rounded-md text-white text-sm font-medium transition-colors ${s.length===0||p?"bg-gray-300 cursor-not-allowed":"bg-pink-500 hover:bg-pink-600"}`,children:s.length===0?"Empty Cart":p?"Processing...":"Confirm purchase"})]})]}),e.jsx(se,{message:f,onClose:()=>M(null),duration:1500}),h&&e.jsx(ce,{cartItems:s,onClose:()=>E(!1),onConfirm:j}),q&&e.jsx(de,{message:"Clear Cart?",subMessage:"Are you sure you want to remove all items from your cart? This action cannot be undone.",onConfirm:()=>{k([]),I(!1),M({type:"info",text:"Cart cleared"})},onCancel:()=>I(!1)}),C&&e.jsx(me,{message:"Leave this Page?",subMessage:"You have an ongoing transaction. Leaving now will discard all unsaved items.",onConfirm:()=>{k([]),A(!1),L&&(z(L),$(null))},onCancel:()=>A(!1)})]})}export{pe as default};
//# sourceMappingURL=SellContent-BektYUmS.js.map
