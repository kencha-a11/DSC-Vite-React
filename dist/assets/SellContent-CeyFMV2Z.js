import{A as K,a as X,r as a,D as H,j as e}from"./index-QMmcz0e6.js";import{e as Q}from"./productServices-aqWy4Wq0.js";import{u as ee}from"./useDebounce-aYV3m3gO.js";import{u as te}from"./useInfiniteScroll-De2QmkUJ.js";import{f as S}from"./formatPeso-BGd6Nsev.js";import{M as se}from"./MessageToast-CLlNtbAC.js";async function ae(t){try{const s=new Date,c=Intl.DateTimeFormat().resolvedOptions().timeZone,n={...t,device_datetime:s.toISOString(),device_timezone:c};return(await K.post("/sales/store",n)).data}catch(s){throw console.error("Transaction failed:",s),console.error("Response:",s.response?.data),s}}function re(){const t=X(),[s,c]=a.useState([]),[n,g]=a.useState([]),[l,f]=a.useState("All"),[b,h]=a.useState(""),[y,p]=a.useState(1),[C,j]=a.useState(!0),[N,w]=a.useState(!1),[q,u]=a.useState(null),[k,v]=a.useState(!1),[E,T]=a.useState(!1),[_,A]=a.useState(!1),[M,R]=a.useState(!1),[D,$]=a.useState(null),I=a.useRef(),d=ee(b,400),L=a.useCallback(async(r=1)=>{w(!0);try{const i=await Q(r,10,d,l),{data:x,hasMore:o}=i;c(m=>r===1?x:[...m,...x]),j(o)}catch{u({type:"error",text:"Failed to load products"})}finally{w(!1)}},[d,l]);a.useEffect(()=>{L(y)},[y,L]),a.useEffect(()=>{c([]),p(1),j(!0)},[d,l]);const B=a.useMemo(()=>{const r=new Set;s.forEach(x=>{Array.isArray(x.categories)&&x.categories.length>0?x.categories.forEach(o=>{o?.name&&r.add(o.name)}):r.add("Uncategorized")});const i=Array.from(r).map((x,o)=>({id:o+1,category_name:x}));return[{id:0,category_name:"All"},...i]},[s]);te(I,()=>{C&&!N&&p(r=>r+1)},C,N);const U=a.useMemo(()=>{const r=new Map;return s.forEach(i=>r.set(i.id,i.stock_quantity??0)),r},[s]),P=a.useCallback(r=>U.get(r)??0,[U]),O=a.useCallback(r=>{g(i=>{const x=i.find(m=>m.id===r.id),o=P(r.id);return x?x.quantity+1>o?(u({type:"info",text:"Stock limit reached"}),i):i.map(m=>m.id===r.id?{...m,quantity:m.quantity+1}:m):o===0?(u({type:"info",text:"Item out of stock"}),i):[...i,{id:r.id,quantity:1,product:r}]})},[P]),V=a.useCallback((r,i)=>{const x=P(r);i>x&&(i=x,u({type:"info",text:"Stock limit reached"})),g(o=>i<=0?o.filter(m=>m.id!==r):o.map(m=>m.id===r?{...m,quantity:i}:m))},[P]),W=a.useMemo(()=>n.reduce((r,i)=>r+Number(i.product?.price??0)*i.quantity,0),[n]),Z=a.useCallback(()=>{if(!n.length)return u({type:"info",text:"Cart is empty"});v(!0)},[n]),G=a.useCallback(async()=>{const r=[...n];if(!r.length){u({type:"info",text:"Cart is empty"}),v(!1);return}v(!1),T(!0);const i=r.reduce((o,m)=>o+Number(m.product.price??0)*m.quantity,0),x={items:r.map(o=>({product_id:o.id,quantity:o.quantity,snapshot_name:o.product.name,snapshot_price:o.product.price})),total_amount:i};try{const o=await ae(x);o?.sale_id||o?.sale?(c(m=>m.map(z=>{const F=r.find(J=>J.id===z.id);return F?{...z,stock_quantity:Math.max((z.stock_quantity??0)-F.quantity,0)}:z})),g([]),u({type:"success",text:o?.message||"Transaction successful!"}),p(1),j(!0)):u({type:"error",text:o?.message||"Transaction failed"})}catch(o){const m=o.response?.data?.message||o.message||"Transaction failed. Try again.";u({type:"error",text:m})}finally{T(!1)}},[n]);return a.useEffect(()=>{const r=i=>{n.length>0&&(i.preventDefault(),i.returnValue="")};return window.addEventListener("beforeunload",r),()=>window.removeEventListener("beforeunload",r)},[n]),{products:s,cartItems:n,categories:B,selectedCategory:l,searchInput:b,loaderRef:I,message:q,showConfirm:k,showClearCartConfirm:_,showLeaveCartDialog:M,isProcessing:E,total:W,isLoading:N,setSearchInput:h,setSelectedCategory:f,handleAddToCart:O,updateCartItem:V,handleCompletePurchase:Z,confirmTransaction:G,setCartItems:g,setShowConfirm:v,setShowClearCartConfirm:A,setShowLeaveCartDialog:R,setMessage:u,navigate:t,pendingNavigation:D,setPendingNavigation:$,getStockFor:P}}function Y(t){return!t.categories||!t.categories.length?"No Category":t.categories.map(s=>s.name).join(", ")}const ne=({product:t,onAdd:s,style:c})=>{const[n,g]=a.useState(!1),l=t?.stock_quantity??t?.stock??0,f=t?.low_stock_threshold??5,b=()=>{l>0&&s(t)},h=t?.images_path?.length>0?t.images_path.find(y=>y.is_primary)?.image_path||t.images_path[0].image_path:t?.image||null;return e.jsxs("div",{style:c,onClick:b,className:`relative flex items-start justify-between p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out ${l<=0?"opacity-50 pointer-events-none":""}`,children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"shrink-0 w-34 h-34 rounded border border-gray-200 flex items-center justify-center bg-gray-100 overflow-hidden",children:h&&!n?e.jsx("img",{src:h,alt:t.name||"Product",className:"w-full h-full object-cover",onError:()=>g(!0)}):e.jsx("span",{className:"text-3xl font-bold text-gray-600 flex items-center justify-center w-full h-full",children:t?.name?.trim()?.charAt(0)?.toUpperCase()||"?"})}),e.jsxs("div",{className:"flex flex-col justify-between h-34 py-1",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-800 leading-tight",children:t.name||"Unnamed Product"}),e.jsx("p",{className:"text-base text-gray-500",children:Y(t)||"No Category"})]}),e.jsxs("p",{className:`text-base ${l<=f?"text-red-500":"text-gray-500"}`,children:["Stocks : ",l]})]})]}),e.jsxs("div",{className:"absolute top-4 right-5 text-base font-semibold text-gray-800 whitespace-nowrap",children:["Unit price : ",S(t.price)]})]})},oe=H.memo(ne);function ie({item:t,product:s,stock:c,onUpdateQuantity:n,onLimit:g}){const l=s?.name??"Unavailable",f=Number(s?.price??0),b=f*t.quantity,[h,y]=a.useState(t.quantity),[p,C]=a.useState(!1);a.useEffect(()=>{y(t.quantity)},[t.quantity]);const j=a.useCallback(u=>{const k=u.target.value.replace(/\D/g,""),v=k===""?"":Math.min(Number(k),c);y(v)},[c]),N=a.useCallback(()=>{const u=Number(h||0);n(t.id,u)},[h,t.id,n]),w=a.useCallback(()=>{t.quantity<c?n(t.id,t.quantity+1):g()},[t.id,t.quantity,c,n,g]),q=a.useCallback(()=>{n(t.id,Math.max(t.quantity-1,0))},[t.id,t.quantity,n]);return e.jsxs("div",{className:"border border-gray-300 rounded-lg p-3 bg-white",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-16 h-16 border border-gray-200 rounded flex items-center justify-center bg-gray-50 overflow-hidden",children:s?.image&&!p?e.jsx("img",{src:s.image,alt:l,className:"object-cover w-full h-full rounded",onError:()=>C(!0)}):e.jsx("span",{className:"text-lg font-bold text-gray-500",children:l.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex flex-col flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:l}),e.jsx("div",{className:"text-xs text-gray-500",children:Y(s)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Stocks: ",c]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["Unit Price: ",S(f)]}),e.jsxs("div",{className:"text-xs text-gray-600 font-medium",children:["Subtotal: ",S(b)]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Quantity:"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:q,type:"button",className:"w-6 h-6 border border-gray-300 rounded text-sm flex items-center justify-center hover:bg-gray-100 transition",children:"âˆ’"}),e.jsx("input",{type:"text",value:h,onChange:j,onBlur:N,className:"w-8 text-center border border-gray-300 rounded text-xs py-0.5"}),e.jsx("button",{onClick:w,type:"button",className:`w-6 h-6 border border-gray-300 rounded text-sm flex items-center justify-center transition ${t.quantity>=c?"opacity-50 cursor-not-allowed":"hover:bg-gray-100"}`,children:"+"})]})]})]})}const le=H.memo(ie,(t,s)=>t.item.quantity===s.item.quantity&&t.stock===s.stock&&t.product===s.product),ce=({cartItems:t=[],onConfirm:s,onClose:c,title:n="Confirm Purchase"})=>{console.log("Rendering ConfirmModal with cartItems:",t);const g=a.useMemo(()=>t.reduce((l,f)=>l+(f.product?.price??0)*f.quantity,0),[t]);return t.length===0?(console.log("ConfirmModal: cartItems empty!"),null):e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-50 px-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col  border-2 border-pink-400",style:{maxHeight:"90vh"},children:[e.jsx("div",{className:"px-6 py-5 border-b border-gray-200",children:e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:n})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:t.map(l=>e.jsxs("div",{className:"flex justify-between items-center py-3 text-base text-gray-700",children:[e.jsxs("span",{className:"font-normal",children:[l.product?.name??"Unavailable"," ",e.jsx("span",{className:"mx-2",children:"x"})," ",l.quantity]}),e.jsx("span",{className:"font-medium",children:S((l.product?.price??0)*l.quantity)})]},l.id))}),e.jsxs("div",{className:"px-6 py-5 border-t border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:"Total:"}),e.jsx("span",{className:"text-lg font-bold text-gray-900",children:S(g)})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:c,className:"px-6 py-2.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-medium",children:"Cancel"}),e.jsx("button",{onClick:s,className:"px-6 py-2.5 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition font-medium",children:"Confirm"})]})]})]})})},de=({onConfirm:t,onCancel:s,message:c,subMessage:n})=>e.jsxs("div",{className:"fixed inset-0 z-1000 flex items-center justify-center px-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black/50",onClick:s}),e.jsxs("div",{className:"relative z-10 bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 border-2 border-pink-500",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 leading-tight",children:c||"Are you sure you want to remove all items from your cart?"}),e.jsx("p",{className:"text-gray-400 text-lg",children:n||"This action cannot be undone."})]}),e.jsxs("div",{className:"mt-8 flex gap-4",children:[e.jsx("button",{onClick:s,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-gray-400 bg-gray-200 hover:bg-gray-300 focus:outline-none transition duration-150 ease-in-out",children:"Cancel"}),e.jsx("button",{onClick:t,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-white bg-pink-500 hover:bg-pink-600 focus:outline-none transition duration-150 ease-in-out",children:"Yes"})]})]})]}),me=({onConfirm:t,onCancel:s,message:c,subMessage:n})=>e.jsxs("div",{className:"fixed inset-0 z-1000 flex items-center justify-center px-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black/50",onClick:s}),e.jsxs("div",{className:"relative z-10 bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 border-2 border-pink-500",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 leading-tight",children:c}),e.jsx("p",{className:"text-gray-400 text-lg",children:n})]}),e.jsxs("div",{className:"mt-8 flex gap-4",children:[e.jsx("button",{onClick:s,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-gray-400 bg-gray-200 hover:bg-gray-300 focus:outline-none transition duration-150 ease-in-out",children:"Cancel"}),e.jsx("button",{onClick:t,className:"flex-1 px-8 py-3.5 rounded-xl text-lg font-semibold text-white bg-pink-500 hover:bg-pink-600 focus:outline-none transition duration-150 ease-in-out",children:"Yes"})]})]})]});function pe(){const{products:t,cartItems:s,categories:c,selectedCategory:n,searchInput:g,loaderRef:l,message:f,showConfirm:b,showClearCartConfirm:h,showLeaveCartDialog:y,isProcessing:p,total:C,isLoading:j,setSearchInput:N,setSelectedCategory:w,handleAddToCart:q,updateCartItem:u,handleCompletePurchase:k,confirmTransaction:v,setCartItems:E,setShowConfirm:T,setShowClearCartConfirm:_,setShowLeaveCartDialog:A,setMessage:M,navigate:R,pendingNavigation:D,setPendingNavigation:$,getStockFor:I}=re();return e.jsxs("div",{className:"flex flex-col md:flex-row h-[91vh]",children:[e.jsxs("div",{className:"flex-1 bg-white border border-gray-200 rounded-xl flex flex-col overflow-hidden mt-4 mx-4",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex gap-3",children:[e.jsx("input",{type:"text",placeholder:"Search items",value:g,onChange:d=>N(d.target.value),className:"flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500"}),e.jsx("select",{value:n,onChange:d=>w(d.target.value),className:"w-40 border border-gray-300 rounded-md px-3 py-2 text-sm focus:border-pink-500 focus:ring-1 focus:ring-pink-500 focus:outline-none transition-colors duration-200",children:c.map(d=>e.jsx("option",{value:d.category_name,children:d.category_name},d.id))})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-2",children:[t.length===0&&!j?e.jsx("div",{className:"text-center text-gray-500 text-sm py-8",children:"No products found"}):e.jsx("div",{className:"space-y-3",children:t.slice().sort((d,L)=>L.stock_quantity-d.stock_quantity).map(d=>e.jsx(oe,{product:d,onAdd:q,disabled:I(d.id)===0},d.id))}),j&&e.jsx("div",{className:"text-center text-gray-400 py-3",children:"Loading more..."}),e.jsx("div",{ref:l,className:"h-20"})]})]}),e.jsxs("div",{className:"w-full md:w-1/3 bg-white border border-gray-200 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"Transaction summary"}),s.length>0&&e.jsx("button",{onClick:()=>_(!0),className:"text-xs font-medium hover:text-gray-700 transition border-2 border-gray-200 p-1 px-2 rounded-md bg-gray-100",children:"Clear all"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:s.length===0?e.jsx("div",{className:"text-center text-sm text-gray-500 py-8",children:"No items selected"}):e.jsx("div",{className:"space-y-4",children:s.map(d=>e.jsx(le,{item:d,product:d.product,stock:I(d.id),onUpdateQuantity:u,onLimit:()=>M({type:"info",text:"Stock limit reached"})},d.id))})}),e.jsxs("div",{className:"border-t border-gray-200 p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("span",{className:"text-sm font-medium",children:"Total"}),e.jsx("span",{className:"text-sm font-semibold",children:S(C)})]}),e.jsx("button",{onClick:k,disabled:s.length===0||p,className:`w-full py-2 rounded-md text-white text-sm font-medium transition-colors ${s.length===0||p?"bg-gray-300 cursor-not-allowed":"bg-pink-500 hover:bg-pink-600"}`,children:s.length===0?"Empty Cart":p?"Processing...":"Confirm purchase"})]})]}),e.jsx(se,{message:f,onClose:()=>M(null),duration:1500}),b&&e.jsx(ce,{cartItems:s,onClose:()=>T(!1),onConfirm:v}),h&&e.jsx(de,{message:"Clear Cart?",subMessage:"Are you sure you want to remove all items from your cart? This action cannot be undone.",onConfirm:()=>{E([]),_(!1),M({type:"info",text:"Cart cleared"})},onCancel:()=>_(!1)}),y&&e.jsx(me,{message:"Leave this Page?",subMessage:"You have an ongoing transaction. Leaving now will discard all unsaved items.",onConfirm:()=>{E([]),A(!1),D&&(R(D),$(null))},onCancel:()=>A(!1)})]})}export{pe as default};
//# sourceMappingURL=SellContent-CeyFMV2Z.js.map
